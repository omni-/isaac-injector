#include "stdafx.h"
#include "hooks.h"
#include "pipe.h"

BOOL APIENTRY DllMain(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)
{
	switch (dwReason)
	{
	case DLL_PROCESS_ATTACH:
		std::ofstream outfile;
		outfile.open("c:/users/cooper/desktop/log.txt", std::ios_base::app);
		outfile << "======================================" << std::endl;
		outfile.close();

		DWORD err;
		std::stringstream ss;
		HANDLE h = initPipe(err);
		hookinit(h);

		AddCollectibleSig.Init((unsigned char*)
			"\x55\x8B\xEC\x83\xE4\xF8\x6A\xFF\x68\x00\x00\x00\x00\x64\xA1\x00\x00\x00\x00\x50\x83\xEC\x78\xA1\x00\x00\x00\x00\x33\xC4\x89\x44\x24\x70\x53\x56\x57\xA1"
			"\x00\x00\x00\x00\x33\xC4\x50\x8D\x84\x24\x88\x00\x00\x00\x64\xA3\x00\x00\x00\x00\x8B\x75\x08\x8B\xD9\x89\x5C\x24\x1C\x89\x74\x24\x24\x81\xFE"

			,
			"xxxxxxxxx????xx????xxxxx????xxxxxxxxxx????xxxxxxxxxx????xxxxxxxxxxxx"
			,
			68);
		PillCardActionSig.Init((unsigned char*)"\x83\xfe\x1b\x0f\x87\x00\x00\x00\x00\xff\x24\xb5\x00\x00\x00\x00\xd9\x05"
			"\x00\x00\x00\x00\x51\x8d\x87\x14\x04\x00\x00\xd9\x1c\x24\x50\x8b\xcf\xe8"
			"\x00\x00\x00\x00\x8b\x8d\x68\xfe\xff\xff\x68\x00\x00\x00\x00\x51\x8b\xcf"
			"\xe8\x00\x00\x00\x00\xe9\x00\x00\x00\x00",
			"xxxxx????xxx????xx????xxxxxxxxxxxxxx????xxxxxxx????xxxx????x????", 64);

		SpawnEntitySig.Init((unsigned char*)"\x55\x8b\xec\x83\xec\x38\x53\x56\x8b\x75\x10\x57\x68\x00\x00\x00\x00\x8b\xde\x6a"
			"\x01\x8b\xf8\x89\x5d\xcc\xe8\x00\x00\x00\x00\xa1\x00\x00\x00\x00\x8b\x0d\x00\x00"
			"\x00\x00\x8b\x15\x00\x00\x00\x00\x89\x45\xd0\x8b\x07",
			"xxxxxxxxxxxxx????xxxxxxxxxx????x????xx????xx????xxxxx", 53);

		ModHealthSig.Init((unsigned char*)"\x55\x8b\xec\x83\xec\x0c\x57\x8b\xf8\x8b\x87\x98\x0b\x00\x00\x83\xf8\x0a\x0f\x84"
			"\x00\x00\x00\x00\x83\xf8\x04\x75\x00\x8b\xc7\xe8\x00\x00\x00\x00\x5f\x8b\xe5\x5d"
			"\xc3\x83\x7f\x10\x01\xba\x00\x00\x00\x00\x89\x55\xfc\x75\x00\xba\x00\x00\x00\x00"
			"\x89\x55\xfc\x8b\x87\x50\x0b\x00\x00",
			"xxxxxxxxxxxxxxxxxxxx????xxxx?xxx????xxxxxxxxxx????xxxx?x????xxxxxxxxx", 69);

		Player_AddCollectible = (AddCollectibleType*)(DetourFunction(PBYTE(AddCollectibleSig.sig_addr), PBYTE(AddCollectible_Hook)));
		Player_PillCardAction = (PillCardActionType*)(DetourFunction(PBYTE(PillCardActionSig.sig_addr), PBYTE(PillCardAction_Hook)));
		Player_ModHealth = (ModHealthType*)(DetourFunction(PBYTE(ModHealthSig.sig_addr), PBYTE(ModHealth_Hook)));
		SpawnEntity = (SpawnEntityType*)(DetourFunction(PBYTE(SpawnEntitySig.sig_addr), PBYTE(SpawnEntity_Hook)));

		break;
	}
	return TRUE;
}
